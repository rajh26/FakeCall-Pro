<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>غرفة اتصال موحدة 000000</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/peerjs/1.4.7/peerjs.min.js"></script>
    <style>
        body { background: #09090b; color: #fff; font-family: -apple-system, system-ui, sans-serif; display: flex; align-items: center; justify-content: center; height: 100vh; margin: 0; }
        .call-card { background: #18181b; padding: 40px; border-radius: 30px; text-align: center; border: 1px solid #27272a; box-shadow: 0 20px 50px rgba(0,0,0,0.5); width: 300px; }
        .room-number { font-size: 48px; font-weight: bold; color: #22c55e; margin: 10px 0; letter-spacing: 5px; }
        .status-dot { width: 12px; height: 12px; background: #ef4444; border-radius: 50%; display: inline-block; margin-left: 8px; }
        .status-dot.online { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
        .btn-join { background: #22c55e; color: white; border: none; border-radius: 50px; padding: 15px 30px; font-size: 18px; font-weight: bold; cursor: pointer; width: 100%; margin-top: 20px; transition: 0.3s; }
        .btn-join:active { transform: scale(0.95); }
        #log { font-size: 12px; color: #71717a; margin-top: 20px; }
    </style>
</head>
<body>

<div class="call-card">
    <div style="color: #71717a; font-size: 14px;">رقم الغرفة الموحد</div>
    <div class="room-number">000000</div>
    
    <div id="status-container">
        <span class="status-dot" id="dot"></span>
        <span id="status-text">جاري الاتصال بالسيرفر...</span>
    </div>

    <button class="btn-join" id="startBtn" onclick="joinCall()">دخول المكالمة الآن</button>
    
    <div id="log">يجب على الجميع الضغط على الزر أعلاه</div>
    <audio id="remote-audio" autoplay></audio>
</div>

<script>
    // الرقم الموحد للجميع
    const ROOM_ID = "GLOBAL_ROOM_000000";
    let peer;

    // تهيئة الاتصال فور فتح الصفحة
    window.onload = () => {
        // توليد معرف عشوائي لكل شخص يدخل الغرفة لكي لا يحدث تضارب
        const myTempId = "User_" + Math.floor(Math.random() * 9999);
        peer = new Peer(myTempId);

        peer.on('open', (id) => {
            document.getElementById('dot').classList.add('online');
            document.getElementById('status-text').innerText = "متصل بالسيرفر";
        });

        // استقبال المكالمات تلقائياً من أي شخص في الغرفة
        peer.on('call', (call) => {
            navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
                call.answer(stream);
                call.on('stream', (remoteStream) => {
                    document.getElementById('remote-audio').srcObject = remoteStream;
                    document.getElementById('status-text').innerText = "أنت الآن في المحادثة";
                });
            });
        });
    };

    function joinCall() {
        document.getElementById('status-text').innerText = "جاري البحث عن أشخاص...";
        
        navigator.mediaDevices.getUserMedia({ audio: true }).then((stream) => {
            // محاولة الاتصال بالمعرف الموحد (أو أول شخص دخل)
            // ملاحظة: في PeerJS المجاني، الاتصال الجماعي يتطلب وسيطاً
            // هنا سنقوم بالاتصال بالمعرف الموحد 000000
            const call = peer.call(ROOM_ID, stream);
            
            // جعل الجهاز نفسه يعمل كمستقبل أيضاً
            const masterPeer = new Peer(ROOM_ID); 
            masterPeer.on('call', (incoming) => {
                incoming.answer(stream);
                incoming.on('stream', (rms) => {
                    document.getElementById('remote-audio').srcObject = rms;
                });
            });

            document.getElementById('status-text').innerText = "الميكروفون نشط";
            document.getElementById('startBtn').style.background = "#3b82f6";
            document.getElementById('startBtn').innerText = "أنت في الغرفة";
        }).catch(err => {
            alert("تأكد من السماح للميكروفون في المتصفح");
        });
    }
</script>

</body>
</html>
