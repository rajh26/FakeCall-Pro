<script>
    // استخدام سيرفر بديل ومستقر
    const peer = new Peer(Math.random().toString(36).substr(2, 9), {
        host: '0.peerjs.com',
        port: 443,
        secure: true
    }); 

    peer.on('open', (id) => {
        console.log('ID Generated: ' + id);
        document.getElementById('my-id-display').innerText = "معرفك: " + id;
        document.getElementById('status').innerText = "جاهز للاتصال";
    });

    peer.on('error', (err) => {
        // في حال حدوث خطأ، سنظهر المعرف يدوياً
        document.getElementById('my-id-display').innerText = "أعد تحديث الصفحة من فضلك";
    });

    // كود بدء المكالمة المحسن
    function startCall() {
        const friendId = document.getElementById('remote-id').value;
        if(!friendId) return alert("أدخل معرف صديقك أولاً");
        
        document.getElementById('status').innerText = "جاري طلب الإذن...";
        
        navigator.mediaDevices.getUserMedia({audio: true}).then((stream) => {
            document.getElementById('status').innerText = "جاري الرنين...";
            const call = peer.call(friendId, stream);
            call.on('stream', (remoteStream) => {
                const audio = document.getElementById('remoteAudio');
                audio.srcObject = remoteStream;
                document.getElementById('status').innerText = "متصل الآن!";
            });
        }).catch(err => {
            alert("يجب السماح للميكروفون من إعدادات المتصفح");
        });
    }
</script>
